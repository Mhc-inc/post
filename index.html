<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
         <title>post</title>
         <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    </head>
<body>
 
 <script language='javascript'>
     var params0 = location.search;
     //判断是否存在status和user
     var storage = localStorage;
     var request = indexedDB.open('weboard', 1);  // 打开 dbName 数据库
     request.onerror = function(e){              // 监听连接数据库失败时执行
         console.log('连接数据库失败');
     }
     var db;
     var value;
     var store;
     var tx;
     request.onupgradeneeded = function (event) {
         db = event.target.result;
         if (!db.objectStoreNames.contains('weboard_list')) { //查看表是否存在，不存在就创建
             // createObjectStore 创建数据库，参数 weboard_list 是创建仓库名称，keyPath：将 "userId" 作为主键，要保证他的唯一性， autoIncrement 是自动递增
             var objectStore = db.createObjectStore("weboard_list", { keyPath: 'userId', autoIncrement: true });
             // 创建一个索引来通过 name 进行搜索，unique 表示是否允许数据的重复
             objectStore.createIndex("user", "user", { unique: false });
             // 手机是不允许重复的所以启用 unique: true
             objectStore.createIndex("status", "status", { unique: false });
         }
     };
     request.onupgradeneeded = function(e){
             db = e.target.result;
             store = db.createObjectStore('weboard_list', {keyPath: 'userId'});
             console.log('创建对象仓库成功');
     }
     if(params0.includes("scope=write") && params0.includes("status") && params0.includes("user") && !params0.includes("removeItem")) {
         params0 = params0.replace("scope=write","");
         var params1 = params0.split("&");
         var keyAndValue0 = params1[0].split("?")[1].split("=");
         var value0 = keyAndValue0[1];
         var key0 = keyAndValue0[0];
         
         var keyAndValue1 = params1[1].split("=");
         var value1 = keyAndValue1[1];
         var key1 = keyAndValue1[0];
         let data0 = null;
         if(key0.includes("user") && key1.includes("status")){
             data0 = {
                 user:value0,
                 status:value1,
             };
         } else {
             data0 = {
                 user:value1,
                 status:value0
             };
         }
         //document.getElementsByTagName("html")[0].innerHTML = data;
         /*
         $.getJSON('https://mhc-inc.github.io/post/save.json', function (data) {
             data[key0]=value0;
             data[key1]=value1;
             document.all[0].innerHTML = JSON.stringify(data);
         })
          */
         if (storage.id) {
             storage.id = Number(storage.id)+1;
             storage.setItem("id",storage.id);
         } else {
             storage.id = 1;
         }
         request.onsuccess = function(e){
             // 监听连接数据库成功时执行
             db = e.target.result;
             tx = db.transaction("weboard_list", 'readwrite');
             store = tx.objectStore('weboard_list');
             var string = 'data'+storage.id;
             value = {
                    'userId': storage.id
                 }
             value[string] = data0;
             var req = store.put(value);
             console.log('连接数据库成功');
         }
         //storage.setItem(string,JSON.stringify(data0));
         //document.all[0].innerHTML = JSON.stringify(storage);
     } else if (params0.includes("scope=read")){
         //document.all[0].innerHTML = JSON.stringify(storage);
         request.onsuccess = function(e){
             // 监听连接数据库成功时执行
             db = e.target.result;
             tx = db.transaction("weboard_list", 'readonly');
             store = tx.objectStore('weboard_list');
             var req = store.getAll();
             req.onsuccess = function(){
                 document.all[0].innerHTML = this.result
             }
             console.log('连接数据库成功');
         }
     }else if (params0.includes("scope=remove") && params0.includes("removeItem")){
         params0.split('removeItem')[1]
         //document.all[0].innerHTML = JSON.stringify(storage);
     } else {
         if(params0.includes("scope=write")){
             document.all[0].innerHTML = JSON.stringify({ 'error' : 'status和user有其中一个键不存在' });
         } else {
             document.all[0].innerHTML = JSON.stringify({ 'error' : 'scope键不存在或它的值存在错误' });
         }
     }
 </script>
 
</body>
 
</html>
